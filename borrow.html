<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="borrow_title">å€Ÿä¹¦ | Family Library</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>

<main class="wrap">
  <div class="form-card">
    <h2 data-i18n="borrow_heading">ğŸ“– å€Ÿä¹¦</h2>
    <div class="form-grid">
      <label data-i18n="label_code">ä¹¦å·</label>
      <input type="text" id="bookId" placeholder="BK0001">

      <label data-i18n="label_name">å€Ÿé˜…äººå§“å</label>
      <input list="borrowerList" type="text" id="borrower" data-i18n-placeholder="placeholder_name" placeholder="è¯·è¾“å…¥å§“å">
      <datalist id="borrowerList"></datalist>
    </div>

    <div class="actions">
      <button class="primary" id="borrowBtn" data-i18n="btn_borrow">å€Ÿå‡º</button>
      <a href="library.html" class="form-note" data-i18n="back_library">â† è¿”å›é¦†è—</a>
    </div>
  </div>
</main>

<footer></footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, update, get, child, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { firebaseConfig } from "./assets/firebase-config.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Auto-fill Book ID
const params = new URLSearchParams(window.location.search);
const bookFromURL = params.get("book");
if (bookFromURL) document.getElementById("bookId").value = bookFromURL;

// Borrower history
function loadBorrowerHistory() {
  try { return JSON.parse(localStorage.getItem("borrowerHistory") || "[]"); }
  catch { return []; }
}
function saveBorrowerName(name) {
  if (!name) return;
  const list = loadBorrowerHistory();
  if (!list.includes(name)) {
    list.push(name);
    localStorage.setItem("borrowerHistory", JSON.stringify(list));
  }
}
function renderBorrowerList() {
  const list = loadBorrowerHistory();
  document.getElementById("borrowerList").innerHTML = list.map(n => `<option value="${n}"></option>`).join("");
}
renderBorrowerList();

// MYT helper
function getMYTDateTime() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const myt = new Date(utc + 8 * 60 * 60000);
  const pad = n => n.toString().padStart(2, "0");
  const date = `${myt.getFullYear()}${pad(myt.getMonth() + 1)}${pad(myt.getDate())}`;
  const time = `${pad(myt.getHours())}${pad(myt.getMinutes())}${pad(myt.getSeconds())}`;
  const human = `${myt.getFullYear()}-${pad(myt.getMonth() + 1)}-${pad(myt.getDate())} ${pad(myt.getHours())}:${pad(myt.getMinutes())}:${pad(myt.getSeconds())}`;
  return { key: `${date}_${time}`, human };
}

async function recordBookAction(bookId, bookName, borrower, actionType) {
  const { key, human } = getMYTDateTime();
  const recordRef = ref(db, `Recordsè®°å½•/${bookId}/${key}`);
  await set(recordRef, {
    "ä¹¦å": bookName || "",
    "å€Ÿé˜…äºº": borrower,
    "æ“ä½œç±»å‹": actionType,
    "æ—¥æœŸæ—¶é—´": `${human} (MYT)`
  });
}

document.getElementById("borrowBtn").addEventListener("click", async () => {
  const bookId = document.getElementById("bookId").value.trim();
  const borrower = document.getElementById("borrower").value.trim();
  const userEmail = localStorage.getItem("userEmail") || "";
  const role = localStorage.getItem("role") || "guest";

  if (!userEmail) return alert("âš ï¸ è¯·å…ˆä½¿ç”¨ Google ç™»å½• / Please sign in first.");
  if (!bookId || !borrower) return alert("è¯·è¾“å…¥ä¹¦å·å’Œå€Ÿé˜…äººå§“åï¼");

  const dbRef = ref(db);
  const snap = await get(child(dbRef, `Booksä¹¦ç±/${bookId}`));
  if (!snap.exists()) return alert("âŒ æœªæ‰¾åˆ°æ­¤ä¹¦ç±ç¼–å·ã€‚");
  const bookData = snap.val();

  if (bookData["å€Ÿé˜…çŠ¶å†µ"] === "å·²è¢«å€Ÿé˜…" && role !== "admin") {
    alert("âš ï¸ æ­¤ä¹¦ç±å·²è¢«å€Ÿå‡ºï¼Œåªæœ‰ç®¡ç†å‘˜å¯æ“ä½œã€‚");
    return;
  }

  await update(ref(db, `Booksä¹¦ç±/${bookId}`), { "å€Ÿé˜…äºº": borrower, "å€Ÿé˜…çŠ¶å†µ": "å·²è¢«å€Ÿé˜…" });
  await recordBookAction(bookId, bookData["ä¹¦å"], borrower, "å€Ÿä¹¦");

  saveBorrowerName(borrower);
  alert("âœ… å€Ÿä¹¦æˆåŠŸ / Book borrowed successfully!");
  location.href = "library.html";
});
</script>

<script src="assets/load-layout.js"></script>
</body>
</html>
