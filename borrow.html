<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>å€Ÿé˜… / å½’è¿˜</title>
<link rel="icon" href="assets/favicon.ico"><link rel="stylesheet" href="assets/style.css">
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");</script>
</head>
<body>
<header></header>
<main class="wrap">
  <div class="form-card">
    <h2>ğŸ“– å€Ÿé˜… / å½’è¿˜</h2>
    <div class="form-grid two"><div><label>ä¹¦å·</label><input id="bookId"></div><div><label>å€Ÿé˜…äººå§“å</label><input id="name"></div></div>
    <div class="actions"><button class="primary" id="borrowBtn">å€Ÿä¹¦</button><button id="returnBtn">è¿˜ä¹¦</button></div>
    <p id="msg" class="form-note"></p><p class="form-note"><a href="library.html">â† è¿”å›é¦†è—</a></p>
  </div>
</main>
<footer></footer>
<script src="assets/load-layout.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, update, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";
  const app=initializeApp(firebaseConfig); const db=getDatabase(app);
  const e=id=>document.getElementById(id), msg=e("msg");
  async function addRecord(bookId,action,name){
    const r=ref(db,`Recordsè®°å½•/${bookId}`); const s=await get(r); const list=s.exists()?s.val():[];
    list.push({æ—¥æœŸæ—¶é—´:new Date().toLocaleString("zh-CN"),æ“ä½œç±»å‹:action,å€Ÿé˜…äºº:name});
    await set(r,list);
  }
  async function borrow(){
    const id=e("bookId").value,name=e("name").value; if(!id||!name)return msg.textContent="è¯·å¡«å†™å®Œæ•´";
    await update(ref(db,`Booksä¹¦ç±/${id}`),{å€Ÿé˜…çŠ¶å†µ:"å·²è¢«å€Ÿé˜…",å€Ÿé˜…äºº:name}); await addRecord(id,"å€Ÿä¹¦",name);
    sendMail("å€Ÿä¹¦",name,id); msg.textContent="âœ… å·²å€Ÿå‡º";
  }
  async function ret(){
    const id=e("bookId").value,name=e("name").value; if(!id||!name)return msg.textContent="è¯·å¡«å†™å®Œæ•´";
    await update(ref(db,`Booksä¹¦ç±/${id}`),{å€Ÿé˜…çŠ¶å†µ:"å¯å€Ÿé˜…",å€Ÿé˜…äºº:""}); await addRecord(id,"è¿˜ä¹¦",name);
    sendMail("è¿˜ä¹¦",name,id); msg.textContent="âœ… å·²å½’è¿˜";
  }
  function sendMail(action,name,book){
    const msg=action==="å€Ÿä¹¦"?`æ‚¨å¥½ ${name}, æ‚¨å·²å€Ÿé˜… ${book}. è¯·æŒ‰æ—¶å½’è¿˜ï¼Œè°¢è°¢!`:`æ‚¨å¥½ ${name}, æ‚¨å·²å½’è¿˜ ${book}. æ„Ÿè°¢é…åˆ!`;
    emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID",{to_name:name,message:msg});
  }
  e("borrowBtn").onclick=borrow; e("returnBtn").onclick=ret;
</script>
</body>
</html>
