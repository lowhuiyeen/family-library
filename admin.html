<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ–°å¢ / ä¿®æ”¹ä¹¦ç±</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>
<main class="wrap">
  <div class="form-card">
    <h2>ğŸ›  æ–°å¢ / ä¿®æ”¹ä¹¦ç±</h2>
    <div class="form-grid two">
      <div><label>ä¹¦å·*</label><input id="code" readonly></div>
      <div><label>ISBNä¹¦å·</label><input id="isbn"></div>
    </div>
    <label>ä¹¦å*</label><input id="title">
    <div class="form-grid two"><div><label>ä½œè€…</label><input id="author"></div><div><label>ç³»åˆ—å</label><input id="series"></div></div>
    <div class="form-grid two"><div><label>å€Ÿé˜…çŠ¶å†µ</label><input id="status" placeholder="å¯å€Ÿé˜… / å·²è¢«å€Ÿé˜…"></div><div><label>å€Ÿé˜…äºº</label><input id="borrower"></div></div>
    <label>Google æœç´¢é“¾æ¥</label><input id="googleLink" readonly>
    <div class="actions"><button class="primary" id="save">ä¿å­˜</button><button id="load">è¯»å–</button><button class="danger" id="del">åˆ é™¤</button></div>
    <p id="msg" class="form-note"></p><p class="form-note"><a href="library.html">â† è¿”å›é¦†è—</a></p>
  </div>
</main>
<footer></footer>
<script src="assets/load-layout.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";
  const app=initializeApp(firebaseConfig); const db=getDatabase(app);
  const e=id=>document.getElementById(id), msg=e("msg");
  const bookParam=new URL(location.href).searchParams.get("book");
  async function genId(){
    try{
      const s=await get(ref(db,"Booksä¹¦ç±")); if(!s.exists())return"BK0001";
      const list=Object.keys(s.val()); const last=list.sort().pop();
      const num=parseInt(last.replace("BK",""))+1; return "BK"+String(num).padStart(4,"0");
    }catch{return "BK0001"}
  }
  document.addEventListener("DOMContentLoaded",async()=>{ e("code").value=bookParam||await genId(); });

  e("save").onclick=async()=>{
    try{
      const code=e("code").value.trim(), title=e("title").value.trim(); if(!title) return msg.textContent="è¯·å¡«å†™ä¹¦å";
      const isbn=e("isbn").value.trim();
      const google=isbn?`https://www.google.com/search?q=${isbn}`:`https://www.google.com/search?q=${encodeURIComponent(title)}`;
      await set(ref(db,`Booksä¹¦ç±/${code}`),{
        ISBNä¹¦å·:isbn,ä¹¦å:title,ä½œè€…:e("author").value,ç³»åˆ—å:e("series").value,
        å€Ÿé˜…çŠ¶å†µ:e("status").value||"å¯å€Ÿé˜…",å€Ÿé˜…äºº:e("borrower").value||"",googleLink:google
      });
      e("googleLink").value=google; msg.textContent="âœ… å·²ä¿å­˜";
    }catch(e){ msg.textContent="âŒ ä¿å­˜å¤±è´¥ï¼š"+(e?.message||e); }
  };

  e("load").onclick=async()=>{
    try{
      const code=e("code").value.trim(); const s=await get(ref(db,`Booksä¹¦ç±/${code}`));
      if(!s.exists()) return msg.textContent="æœªæ‰¾åˆ°"; const b=s.val();
      e("isbn").value=b["ISBNä¹¦å·"]||""; e("title").value=b["ä¹¦å"]||""; e("author").value=b["ä½œè€…"]||"";
      e("series").value=b["ç³»åˆ—å"]||""; e("status").value=b["å€Ÿé˜…çŠ¶å†µ"]||""; e("borrower").value=b["å€Ÿé˜…äºº"]||""; e("googleLink").value=b["googleLink"]||"";
      msg.textContent="âœ… å·²è¯»å–";
    }catch(e){ msg.textContent="âŒ è¯»å–å¤±è´¥ï¼š"+(e?.message||e); }
  };

  e("del").onclick=async()=>{
    try{
      const code=e("code").value.trim(); if(!confirm("ç¡®å®šåˆ é™¤?")) return;
      await remove(ref(db,`Booksä¹¦ç±/${code}`)); msg.textContent="ğŸ—‘ å·²åˆ é™¤ "+code;
    }catch(e){ msg.textContent="âŒ åˆ é™¤å¤±è´¥ï¼š"+(e?.message||e); }
  };
</script>
</body>
</html>
