<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Тќ░тбъ / С┐«Тћ╣С╣ду▒Ї</title>
  <link rel="icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>
<main class="wrap">
  <div class="form-card">
    <h2>­ЪЏа Тќ░тбъ / С┐«Тћ╣С╣ду▒Ї</h2>
    <div class="form-grid two">
      <div><label>С╣дтЈи*</label><input id="code" readonly></div>
      <div><label>ISBNС╣дтЈи</label><input id="isbn"></div>
    </div>
    <label>С╣дтљЇ*</label><input id="title">
    <div class="form-grid two"><div><label>СйюУђЁ</label><input id="author"></div><div><label>у│╗тѕЌтљЇ</label><input id="series"></div></div>
    <div class="form-grid two"><div><label>тђЪжўЁуіХтєх</label><input id="status" placeholder="тЈ»тђЪжўЁ / ти▓УбФтђЪжўЁ"></div><div><label>тђЪжўЁС║║</label><input id="borrower"></div></div>
    <label>Google Тљюу┤бжЊЙТјЦ</label><input id="googleLink" readonly>
    <div class="actions"><button class="primary" id="save">С┐ЮтГў</button><button id="load">У»╗тЈќ</button><button class="danger" id="del">тѕажЎц</button></div>
    <p id="msg" class="form-note"></p><p class="form-note"><a href="library.html">Рєљ У┐ћтЏъждєУЌЈ</a></p>
  </div>
</main>
<footer></footer>
<script src="assets/load-layout.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";
  const app=initializeApp(firebaseConfig); const db=getDatabase(app);
  const e=id=>document.getElementById(id); const msg=e("msg");
  const bookParam=new URL(location.href).searchParams.get("book");
  async function genId(){
    const s=await get(ref(db,"BooksС╣ду▒Ї")); if(!s.exists())return"BK0001";
    const list=Object.keys(s.val()); const last=list.sort().pop();
    const num=parseInt(last.replace("BK",""))+1; return "BK"+String(num).padStart(4,"0");
  }
  document.addEventListener("DOMContentLoaded",async()=>{ e("code").value=bookParam||await genId(); });
  e("save").onclick=async()=>{
    const code=e("code").value.trim(), title=e("title").value.trim(); if(!title)return msg.textContent="У»итАФтєЎС╣дтљЇ";
    const isbn=e("isbn").value.trim();
    const google=isbn?`https://www.google.com/search?q=${isbn}`:`https://www.google.com/search?q=${encodeURIComponent(title)}`;
    await set(ref(db,`BooksС╣ду▒Ї/${code}`),{
      ISBNС╣дтЈи:isbn,С╣дтљЇ:title,СйюУђЁ:e("author").value,у│╗тѕЌтљЇ:e("series").value,
      тђЪжўЁуіХтєх:e("status").value||"тЈ»тђЪжўЁ",тђЪжўЁС║║:e("borrower").value||"",googleLink:google
    });
    e("googleLink").value=google; msg.textContent="РюЁ ти▓С┐ЮтГў";
  };
  e("load").onclick=async()=>{
    const code=e("code").value.trim(); const s=await get(ref(db,`BooksС╣ду▒Ї/${code}`));
    if(!s.exists())return msg.textContent="ТюфТЅЙтѕ░"; const b=s.val();
    for(const k of ["isbn","title","author","series","status","borrower","googleLink"]){ const el=e(k); if(el) el.value=b[el.id==="isbn"?"ISBNС╣дтЈи":el.id]||""; }
    msg.textContent="РюЁ ти▓У»╗тЈќ";
  };
  e("del").onclick=async()=>{ if(!confirm("уА«т«џтѕажЎц?"))return; await remove(ref(db,`BooksС╣ду▒Ї/${e("code").value}`)); msg.textContent="­ЪЌЉ ти▓тѕажЎц"; };
</script>
</body>
</html>
