<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="admin_title">æ–°å¢ / ä¿®æ”¹ä¹¦ç±</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>

<main class="wrap">
  <div class="form-card">
    <h2 data-i18n="admin_heading">ğŸ›  æ–°å¢ / ä¿®æ”¹ä¹¦ç±</h2>

    <div class="form-grid two">
      <div>
        <label data-i18n="label_code">ä¹¦å·*</label>
        <input id="code" readonly>
      </div>
      <div>
        <label data-i18n="label_isbn">ISBNä¹¦å·</label>
        <input id="isbn">
      </div>
    </div>

    <label data-i18n="label_title">ä¹¦å*</label>
    <input id="title">

    <div class="form-grid two">
      <div>
        <label data-i18n="label_author">ä½œè€…</label>
        <input id="author">
      </div>
      <div>
        <label data-i18n="label_series">ç³»åˆ—å</label>
        <input id="series">
      </div>
    </div>

    <div class="form-grid two">
      <div>
        <label data-i18n="label_status">å€Ÿé˜…çŠ¶å†µ</label>
        <input id="status" data-i18n-placeholder="placeholder_status">
      </div>
      <div>
        <label data-i18n="label_borrower">å€Ÿé˜…äºº</label>
        <input id="borrower" data-i18n-placeholder="placeholder_borrower">
      </div>
    </div>

    <label data-i18n="label_google">Google æœç´¢é“¾æ¥</label>
    <input id="googleLink" readonly>

    <div class="actions">
      <button class="primary" id="save" data-i18n="btn_save">ä¿å­˜</button>
      <button id="load" data-i18n="btn_load">è¯»å–</button>
      <button class="danger" id="del" data-i18n="btn_delete">åˆ é™¤</button>
    </div>

    <p id="msg" class="form-note"></p>
    <p class="form-note"><a href="library.html" data-i18n="back_library">â† è¿”å›é¦†è—</a></p>
  </div>
</main>

<footer></footer>
<script src="assets/load-layout.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const e = id => document.getElementById(id);
  const msg = e("msg");
  const bookParam = new URL(location.href).searchParams.get("book");

  async function genId() {
    try {
      const s = await get(ref(db, "Booksä¹¦ç±"));
      if (!s.exists()) return "BK0001";
      const list = Object.keys(s.val());
      const last = list.sort().pop();
      const num = parseInt(last.replace("BK", "")) + 1;
      return "BK" + String(num).padStart(4, "0");
    } catch {
      return "BK0001";
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    e("code").value = bookParam || await genId();
  });

  e("save").onclick = async () => {
    const lang = localStorage.getItem("lang") || "zh";
    const MSG = {
      zh: { titleReq: "è¯·å¡«å†™ä¹¦å", ok: "âœ… å·²ä¿å­˜", fail: "âŒ ä¿å­˜å¤±è´¥ï¼š" },
      en: { titleReq: "Please enter the book title", ok: "âœ… Saved successfully", fail: "âŒ Save failed: " },
      jp: { titleReq: "æ›¸åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", ok: "âœ… ä¿å­˜å®Œäº†", fail: "âŒ ä¿å­˜å¤±æ•—: " }
    }[lang];
    try {
      const code = e("code").value.trim();
      const title = e("title").value.trim();
      if (!title) return msg.textContent = MSG.titleReq;
      const isbn = e("isbn").value.trim();
      const google = isbn ? `https://www.google.com/search?q=${isbn}` : `https://www.google.com/search?q=${encodeURIComponent(title)}`;
      await set(ref(db, `Booksä¹¦ç±/${code}`), {
        ISBNä¹¦å·: isbn,
        ä¹¦å: title,
        ä½œè€…: e("author").value,
        ç³»åˆ—å: e("series").value,
        å€Ÿé˜…çŠ¶å†µ: e("status").value || "å¯å€Ÿé˜…",
        å€Ÿé˜…äºº: e("borrower").value || "",
        googleLink: google
      });
      e("googleLink").value = google;
      msg.textContent = MSG.ok;
    } catch (e) {
      msg.textContent = MSG.fail + (e?.message || e);
    }
  };

  e("load").onclick = async () => {
    const lang = localStorage.getItem("lang") || "zh";
    const MSG = {
      zh: { notFound: "æœªæ‰¾åˆ°", ok: "âœ… å·²è¯»å–", fail: "âŒ è¯»å–å¤±è´¥ï¼š" },
      en: { notFound: "Not found", ok: "âœ… Loaded successfully", fail: "âŒ Load failed: " },
      jp: { notFound: "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", ok: "âœ… èª­ã¿è¾¼ã¿å®Œäº†", fail: "âŒ èª­ã¿è¾¼ã¿å¤±æ•—: " }
    }[lang];
    try {
      const code = e("code").value.trim();
      const s = await get(ref(db, `Booksä¹¦ç±/${code}`));
      if (!s.exists()) return msg.textContent = MSG.notFound;
      const b = s.val();
      e("isbn").value = b["ISBNä¹¦å·"] || "";
      e("title").value = b["ä¹¦å"] || "";
      e("author").value = b["ä½œè€…"] || "";
      e("series").value = b["ç³»åˆ—å"] || "";
      e("status").value = b["å€Ÿé˜…çŠ¶å†µ"] || "";
      e("borrower").value = b["å€Ÿé˜…äºº"] || "";
      e("googleLink").value = b["googleLink"] || "";
      msg.textContent = MSG.ok;
    } catch (e) {
      msg.textContent = MSG.fail + (e?.message || e);
    }
  };

  e("del").onclick = async () => {
    const lang = localStorage.getItem("lang") || "zh";
    const MSG = {
      zh: { confirm: "ç¡®å®šåˆ é™¤ï¼Ÿ", ok: "ğŸ—‘ å·²åˆ é™¤", fail: "âŒ åˆ é™¤å¤±è´¥ï¼š" },
      en: { confirm: "Are you sure to delete?", ok: "ğŸ—‘ Deleted", fail: "âŒ Delete failed: " },
      jp: { confirm: "å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ", ok: "ğŸ—‘ å‰Šé™¤å®Œäº†", fail: "âŒ å‰Šé™¤å¤±æ•—: " }
    }[lang];
    try {
      const code = e("code").value.trim();
      if (!confirm(MSG.confirm)) return;
      await remove(ref(db, `Booksä¹¦ç±/${code}`));
      msg.textContent = `${MSG.ok} ${code}`;
    } catch (e) {
      msg.textContent = MSG.fail + (e?.message || e);
    }
  };
</script>
</body>
</html>
