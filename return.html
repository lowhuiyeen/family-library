<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="return_title">è¿˜ä¹¦ / Return Book</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>

<main class="wrap">
  <div class="form-card">
    <h2 data-i18n="return_heading">ğŸ“¦ è¿˜ä¹¦</h2>
    <div class="form-grid two">
      <div>
        <label data-i18n="label_code">ä¹¦å·</label>
        <input id="bookId" readonly>
      </div>
      <div>
        <label data-i18n="label_name">å€Ÿé˜…äººå§“å</label>
        <input id="name" data-i18n-placeholder="placeholder_name">
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="returnBtn" data-i18n="btn_return">å½’è¿˜</button>
    </div>
    <p id="msg" class="form-note"></p>
    <p class="form-note"><a href="library.html" data-i18n="back_library">â† è¿”å›é¦†è—</a></p>
  </div>
</main>

<footer></footer>
<script src="assets/load-layout.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, update, get, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const e = id => document.getElementById(id);
  const msg = e("msg");

  const params = new URLSearchParams(location.search);
  const book = params.get("book");
  if (book) e("bookId").value = book;

  async function addRecord(bookId, action, name) {
    const r = ref(db, `Recordsè®°å½•/${bookId}`);
    const s = await get(r);
    const list = s.exists() ? s.val() : [];
    list.push({ æ—¶é—´: new Date().toLocaleString(), æ“ä½œ: action, å€Ÿé˜…äºº: name });
    await set(r, list);
  }

  async function returnBook() {
    const lang = localStorage.getItem("lang") || "zh";
    const DICT = {
      zh: { fill: "âš ï¸ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯", ok: "âœ… å·²æˆåŠŸå½’è¿˜", err: "âŒ é”™è¯¯ï¼š" },
      en: { fill: "âš ï¸ Please fill in all fields.", ok: "âœ… Returned successfully!", err: "âŒ Error: " },
      jp: { fill: "âš ï¸ å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", ok: "âœ… è¿”å´å®Œäº†ï¼", err: "âŒ ã‚¨ãƒ©ãƒ¼: " }
    }[lang];

    try {
      const id = e("bookId").value.trim(), name = e("name").value.trim();
      if (!id || !name) return msg.textContent = DICT.fill;
      await update(ref(db, `Booksä¹¦ç±/${id}`), { å€Ÿé˜…çŠ¶å†µ: "å¯å€Ÿé˜…", å€Ÿé˜…äºº: "" });
      await addRecord(id, "è¿˜ä¹¦", name);
      msg.textContent = DICT.ok;
    } catch (err) {
      msg.textContent = DICT.err + (err.message || err);
    }
  }

  e("returnBtn").onclick = returnBook;
</script>
</body>
</html>
