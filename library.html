<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="title">å°é‡‘åº“å›¾ä¹¦é¦†</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>

<main class="wrap">
  <div class="toolbar" style="display:grid;gap:10px;grid-template-columns:1fr 240px auto;">
    <input id="q" data-i18n-placeholder="search_placeholder">
    <select id="status">
      <option value="" data-i18n="status_all"></option>
      <option value="å¯å€Ÿé˜…" data-i18n="status_avail"></option>
      <option value="å·²è¢«å€Ÿé˜…" data-i18n="status_borrowed"></option>
    </select>
    <button class="primary" id="addBtn"><span data-i18n="add_book"></span></button>
  </div>

  <div class="card" style="margin-top:14px;">
    <table>
      <thead>
        <tr>
          <th data-i18n="col_code">ä¹¦å·</th>
          <th data-i18n="col_title">ä¹¦å / å€Ÿé˜…äºº</th>
          <th data-i18n="col_author">ä½œè€…</th>
          <th data-i18n="col_series">ç³»åˆ—</th>
          <th data-i18n="col_isbn">ISBN</th>
          <th data-i18n="col_status">çŠ¶æ€</th>
          <th data-i18n="col_action">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="7" class="muted" data-i18n="loading">åŠ è½½ä¸­...</td></tr></tbody>
    </table>
  </div>
</main>

<footer></footer>
<script src="assets/load-layout.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
  import { firebaseConfig } from "./assets/firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const qEl = document.getElementById('q');
  const statusEl = document.getElementById('status');
  const tbody = document.getElementById('tbody');
  const addBtn = document.getElementById('addBtn');
  const role = localStorage.getItem("role") || "guest";

  if (role === "guest") addBtn.style.display = "none";
  else addBtn.onclick = () => location.href = 'admin.html';

  qEl.oninput = render;
  statusEl.onchange = render;

  let books = {};

  onValue(ref(db, "Booksä¹¦ç±"), (snap) => {
    books = snap.val() || {};
    render();
  }, err => {
    tbody.innerHTML = `<tr><td colspan="7" class="muted">åŠ è½½å¤±è´¥ï¼š${err?.message || ''}</td></tr>`;
  });

  // ğŸ” re-render when language is switched via header flags
  window.addEventListener("languagechange", render);

  function render() {
    const q = (qEl.value || '').toLowerCase();
    const s = statusEl.value;

    const rows = Object.entries(books)
      .map(([id, b]) => ({ ä¹¦å·: id, ...b }))
      .filter(r => {
        const matchQ = !q || [r.ä¹¦å·, r.ä¹¦å, r.ä½œè€…].join(' ').toLowerCase().includes(q);
        const matchS = !s || r.å€Ÿé˜…çŠ¶å†µ === s; // values in DB stay Chinese
        return matchQ && matchS;
      });

    const lang = localStorage.getItem("lang") || "zh";
    const T = {
      zh: { avail: "å¯å€Ÿé˜…", borrowed: "å·²è¢«å€Ÿé˜…", borrower: "å€Ÿé˜…äºº", edit: "ç¼–è¾‘", borrow: "å€Ÿä¹¦" },
      en: { avail: "Available", borrowed: "Borrowed", borrower: "Borrower", edit: "Edit", borrow: "Borrow" },
      jp: { avail: "è²¸å‡ºå¯", borrowed: "è²¸å‡ºä¸­", borrower: "å€Ÿã‚Šæ‰‹", edit: "ç·¨é›†", borrow: "å€Ÿã‚Šã‚‹" }
    }[lang];

    tbody.innerHTML = rows.length ? rows.map(r => {
      const isAvail = r.å€Ÿé˜…çŠ¶å†µ === "å¯å€Ÿé˜…";
      const statusText = isAvail ? T.avail : T.borrowed;             // âœ… translated status
      const borrowerInfo = r.å€Ÿé˜…äºº ? `${T.borrower}ï¼š${r.å€Ÿé˜…äºº}` : T.avail; // âœ… translated label

      return `
        <tr>
          <td>${r.ä¹¦å·}</td>
          <td><strong>${r.ä¹¦å || ''}</strong><br><small class="muted">${borrowerInfo}</small></td>
          <td>${r.ä½œè€… || ''}</td>
          <td>${r.ç³»åˆ—å || ''}</td>
          <td>${r['ISBNä¹¦å·'] || ''}</td>
          <td><span class="${isAvail ? 'badge ok' : 'badge warn'}">${statusText}</span></td>
          <td>
            ${role === "admin"
              ? `<a href='admin.html?book=${r.ä¹¦å·}'>${T.edit}</a> Â· <a href='borrow.html?book=${r.ä¹¦å·}'>${T.borrow}</a>`
              : `<a href='login.html?redirect=${encodeURIComponent('borrow.html?book=' + r.ä¹¦å·)}' style="color:var(--accent)">${T.borrow}</a>`}
          </td>
        </tr>
      `;
    }).join('') : `<tr><td colspan="7" class="muted">æ— åŒ¹é…ç»“æœ</td></tr>`;
  }
</script>

window.addEventListener("languagechange", render);

</body>
</html>
