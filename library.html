<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="title">小金库图书馆</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<header></header>

<main class="wrap">
  <div class="toolbar" style="display:grid;gap:10px;grid-template-columns:1fr 240px auto;">
    <input id="q" data-i18n-placeholder="search_placeholder">
    <select id="status">
      <option value="" data-i18n="status_all"></option>
      <option value="可借阅" data-i18n="status_avail"></option>
      <option value="已被借阅" data-i18n="status_borrowed"></option>
    </select>
    <button class="primary" id="addBtn"><span data-i18n="add_book"></span></button>
  </div>

  <div class="card" style="margin-top:14px;">
    <table>
      <thead>
        <tr>
          <th data-i18n="col_code">书号</th>
          <th data-i18n="col_title">书名 / 借阅人</th>
          <th data-i18n="col_author">作者</th>
          <th data-i18n="col_series">系列</th>
          <th data-i18n="col_isbn">ISBN</th>
          <th data-i18n="col_status">状态</th>
          <th data-i18n="col_action">操作</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="muted" style="text-align:center;">⏳ 加载中 / Loading...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<footer></footer>

<script src="assets/load-layout.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import { firebaseConfig } from "./assets/firebase-config.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const qEl = document.getElementById("q");
const statusEl = document.getElementById("status");
const tbody = document.getElementById("tbody");
const addBtn = document.getElementById("addBtn");
const role = localStorage.getItem("role") || "guest";

if (role !== "admin") {
  addBtn.style.display = "none";
} else {
  addBtn.onclick = () => (location.href = "admin.html");
}

qEl.oninput = render;
statusEl.onchange = render;

let books = {};
onValue(ref(db, "Books书籍"), (snap) => {
  books = snap.val() || {};
  render();
}, (err) => {
  tbody.innerHTML = `<tr><td colspan="7" class="muted">加载失败：${err?.message || ""}</td></tr>`;
});

window.addEventListener("languagechange", render);

function render() {
  const q = (qEl.value || "").toLowerCase();
  const s = statusEl.value;

  const rows = Object.entries(books)
    .map(([id, b]) => ({ 书号: id, ...b }))
    .filter((r) => {
      const matchQ = !q || [r.书号, r.书名, r.作者].join(" ").toLowerCase().includes(q);
      const matchS = !s || r.借阅状况 === s;
      return matchQ && matchS;
    });

  const lang = localStorage.getItem("lang") || "zh";
  const T = {
    zh: { avail: "可借阅", borrowed: "已被借阅", borrower: "借阅人", edit: "编辑", borrow: "借书", return: "还书" },
    en: { avail: "Available", borrowed: "Borrowed", borrower: "Borrower", edit: "Edit", borrow: "Borrow", return: "Return" },
    jp: { avail: "貸出可", borrowed: "貸出中", borrower: "借り手", edit: "編集", borrow: "借りる", return: "返す" },
  }[lang];

  tbody.innerHTML = rows.length
    ? rows.map((r) => {
        const isAvail = r.借阅状况 === "可借阅";
        const statusText = isAvail ? T.avail : T.borrowed;
        const borrowerInfo = r.借阅人 ? `${T.borrower}：${r.借阅人}` : T.avail;
        const role = localStorage.getItem("role") || "guest";

        let actionHTML = "";
        if (role === "admin") {
          actionHTML = `
            <a href='admin.html?book=${r.书号}'>${T.edit}</a>
            ${isAvail
              ? ` · <a href='borrow.html?book=${r.书号}'>${T.borrow}</a>`
              : ` · <a href='return.html?book=${r.书号}'>${T.return}</a>`}
          `;
        } else {
          if (isAvail) {
            actionHTML = `<a href='login.html?redirect=${encodeURIComponent(
              "borrow.html?book=" + r.书号
            )}' style="color:var(--accent)">${T.borrow}</a>`;
          } else {
            actionHTML = `<span class="muted" style="opacity:0.6;">${T.borrowed}</span>`;
          }
        }

        return `
          <tr>
            <td>${r.书号}</td>
            <td><strong>${r.书名 || ""}</strong><br><small class="muted">${borrowerInfo}</small></td>
            <td>${r.作者 || ""}</td>
            <td>${r.系列名 || ""}</td>
            <td>${r["ISBN书号"] || ""}</td>
            <td><span class="${isAvail ? "badge ok" : "badge warn"}">${statusText}</span></td>
            <td>${actionHTML}</td>
          </tr>
        `;
      }).join("")
    : `<tr><td colspan="7" class="muted">无匹配结果</td></tr>`;
}
</script>
</body>
</html>
